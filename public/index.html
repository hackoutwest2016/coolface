<!doctype html>
<html>
<head>
  <title>Jukebox!</title>
  
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Jukebox!</h1>
    <h2>Search for an Artist</h2>

    <form id="search-form">
      <div class="input-group">
        <input type="text" id="query" class="form-control" placeholder="Search for artist...">
        <span class="input-group-btn">
          <button  type="submit" id="search" class="btn btn-default" value="Search">Search</button>
        </span>
      </div>
    </form>

    <div>
      <ul id="results" class="list-group"></ul>
    </div>

    <div class="list">
      <h2>Queue</h2>
      <ul id="queue" class="list-group"></ul>
    </div>
  </div>

  <script>
  var resultsPlaceholder = document.getElementById('results');
  var queue = document.getElementById('queue');

  var searchArtist = function (searchString) {
    $.ajax({
      url: '/search?text=' + searchString,
      dataType: 'json',
      success: function (response) {

        for (var i = 0; i < response.length; i++) {

          var artist = response[i].artist[0].name,
          track = response[i].name,
          trackId = response[i].id;

          resultsPlaceholder.innerHTML += '<li class="list-group-item">' + artist + ': ' + track + ': ' + trackId +
          ' <button id=' + trackId + ' class="btn btn-default btn-vote">Add to queue</button></li>';
        }

        for (var i = 0; i < voteButtons.length; i++) {
          voteButtons[i].addEventListener('click', voteTrack, false);
        }

      }
    });
  };

  document.getElementById('search-form').addEventListener('submit', function (e) {
    e.preventDefault();
    searchArtist(document.getElementById('query').value);
  }, false);

  var voteButtons = document.getElementsByClassName("btn-vote");

  var voteTrack = function(id) {
    this.classList += ' disabled';
    console.log("Vote for track id: " + this.id);
    $.ajax({
      url: '/upvote?track_id=' + this.id,
      success: function (resp) {
        console.log("hello");
        getList();
      }
    })
  };

  var getList = function() {
    $.ajax({
      url: '/list',
      method: 'GET',
      dataType: 'json',
      success: function (data) {
        console.log(data);
        updateQueue(data);
      }
    });
  }

  var updateQueue = function(data){

    queue.innerHTML = "";

    for (var i = 0; i < data.length; i++) {

      var artist = data[i].artists[0].name,
          track = data[i].track_name,
          trackId = data[i].id,
          votes = data[i].vote_count;

      console.log(trackId);

      queue.innerHTML += '<li class="list-group-item">' + artist + ': ' + track + ': ' + trackId +
      '<span class="votes">' + votes + '</span>' +
      ' <button id=' + trackId + ' class="btn btn-default btn-vote">Vote</button>';
    }

    for (var i = 0; i < voteButtons.length; i++) {
      voteButtons[i].addEventListener('click', voteTrack, false);
    }

    // $('#queue-list').innerHTML += '<li class="list-group-item">' + artist + ': ' + track + ': ' + trackId +
    // ' <button id=' + trackId + ' class="btn btn-default btn-vote">Add to que</button>';
  };

  window.onload = function () {
    getList();
  };

  </script>
</body>
</html>

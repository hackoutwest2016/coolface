<!doctype html>
<html>
<head>
  <title>Jukebox!</title>

  <meta name="viewport" content="initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Jukebox!</h1>

    <h2>Playing right now: [SONG]</h2>
    <h2>Search for an artist</h2>

    <form id="search-form">
      <div class="input-group">
        <input type="text" id="query" class="form-control" placeholder="Search for artist...">
        <span class="input-group-btn">
          <button  type="submit" id="search" class="btn btn-default" value="Search">Search</button>
        </span>
      </div>
    </form>

    <div>
      <ul id="results" class="list-group"></ul>
    </div>

    <div class="list">
      <h2>Queue</h2>
      <ul id="queue" class="list-group"></ul>
    </div>
  </div>

  <script>
  var resultsPlaceholder = document.getElementById('results');
  var queue = document.getElementById('queue');
  var addButtons = document.getElementsByClassName("btn-add");
  var voteButtons = document.getElementsByClassName("btn-vote");

  var votedSongs = [];

  var searchArtist = function (searchString) {

    if(searchString.length <1 ){
      return;
    }

    $.ajax({
      url: '/search?text=' + searchString,
      dataType: 'json',
      success: function (response) {

        cleanNode(resultsPlaceholder);

        for (var i = 0; i < response.length; i++) {
          var artist = response[i].artist[0].name,
          track = response[i].name,
          trackId = response[i].id;

          var disabled = "";

          if (hasUserVotedForThisSong(trackId)) {
            disabled = "disabled";
          }


          resultsPlaceholder.innerHTML += '<li class="list-group-item">' + track + ' - ' + artist +
          ' <button id=' + trackId + ' class="btn btn-default btn-add ' + disabled +'">Add to queue</button></li>';

        }

        for (var i = 0; i < addButtons.length; i++) {
          addButtons[i].addEventListener('click', function(){
            this.setAttribute("disabled", "true");
            voteTrack(this.id);
            cleanNode(resultsPlaceholder);
          }, false);
        }

      }
    });
  };

  document.getElementById('search-form').addEventListener('submit', function (e) {
    e.preventDefault();
    searchArtist(document.getElementById('query').value);
  }, false);

  var voteTrack = function(id) {
    if(!hasUserVotedForThisSong(id)){
      votedSongs.push(id);
    };

    $.ajax({
      url: '/upvote?track_id=' + id,
      success: function (resp) {
        getList();
      }
    });
  };

  var getList = function() {
    $.ajax({
      url: '/list',
      method: 'GET',
      dataType: 'json',
      success: function (data) {
        updateQueue(data);
        console.log(data);
      }
    });
  }

  var cleanNode = function (node){
    while (node.hasChildNodes()) {
      node.removeChild(node.lastChild);
    }
  };

  var updateQueue = function(data){

    cleanNode(queue);

    for (var i = 0; i < data.length; i++) {

      var artist = data[i].artists[0].name,
          track = data[i].track_name,
          trackId = data[i].id,
          votes = data[i].vote_count;

      var disabled = "";

      if (hasUserVotedForThisSong(trackId)) {
        disabled = "disabled";
      }

      queue.innerHTML += '<li class="list-group-item">' + artist + ' - ' + track +
      '<span class="votes">' + votes + '</span>' +
      ' <button id=' + trackId + ' class="btn btn-default btn-vote ' + disabled +'">Vote</button>';
    }

    for (var i = 0; i < voteButtons.length; i++) {
      voteButtons[i].addEventListener('click', function(){
        voteTrack(this.id);
      }, false);
    }

  };

  var hasUserVotedForThisSong = function (id) {
    if (votedSongs.indexOf(id) !== -1) {
      return true;
    } else {
      return false;
    }
  };

  window.onload = function () {
    getList();
  };

  setInterval(function () {
    getList();
  }, 15000);

  </script>
</body>
</html>
